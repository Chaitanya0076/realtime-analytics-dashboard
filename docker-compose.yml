version: "3.8"

# =============================================================================
# PRODUCTION DOCKER COMPOSE - For EC2 Deployment
# =============================================================================
# 
# IMPORTANT: Before deploying, set the EC2_PUBLIC_IP environment variable:
#   export EC2_PUBLIC_IP="your.ec2.public.ip"
#   docker-compose up -d
#
# Or create a .env file in the same directory with:
#   EC2_PUBLIC_IP=your.ec2.public.ip
# =============================================================================

services:
  redpanda:
    image: redpandadata/redpanda:latest
    container_name: redpanda
    restart: always
    # Two Kafka listeners:
    # - internal (port 9002): for processor on same EC2 host, advertises localhost
    # - external (port 9003): for Vercel, advertises EC2 public IP
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - 1G
      - --reserve-memory
      - 0M
      - --node-id
      - "0"
      - --check=false
      # Internal listener (for processor on EC2 host)
      - --kafka-addr
      - internal://0.0.0.0:9002,external://0.0.0.0:9003
      # Advertise addresses: internal→localhost, external→public IP
      - --advertise-kafka-addr
      - internal://localhost:9002,external://${EC2_PUBLIC_IP}:9003
    ports:
      - "127.0.0.1:9002:9002"  # Internal: only localhost (for processor)
      - "0.0.0.0:9003:9003"    # External: all interfaces (for Vercel)
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  redis:
    image: "redis:latest"
    container_name: analytics-redis
    restart: always
    ports:
      - "0.0.0.0:6379:6379"  # Bind to all interfaces for external access (Vercel)
    # Optional: Add password protection for production
    # command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

volumes:
  redpanda-data: